




<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Building &mdash; CLIP OS 5.0.0_alpha1 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/colors.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Source tree organization" href="source-tree.html" />
    <link rel="prev" title="Environment setup" href="setup.html" /> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> CLIP OS
          

          
            
            <img src="../_static/clipos_logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                5.0 (Alpha)
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">CLIP OS</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../clipos/architecture.html">Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../clipos/security.html">Security objectives</a></li>
<li class="toctree-l1"><a class="reference internal" href="../clipos/kernel.html">Kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../clipos/secure_boot.html">Secure Boot support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../clipos/roadmap.html">Roadmap</a></li>
</ul>
<p class="caption"><span class="caption-text">Development environment</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="setup.html">Environment setup</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Building</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#activate-the-toolkit-environment">Activate the toolkit environment</a></li>
<li class="toctree-l2"><a class="reference internal" href="#build-steps">Build steps</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#building-the-documentation">Building the documentation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#caching-and-binary-packages">Caching and binary packages</a></li>
<li class="toctree-l3"><a class="reference internal" href="#sdk">SDK</a></li>
<li class="toctree-l3"><a class="reference internal" href="#core">Core</a></li>
<li class="toctree-l3"><a class="reference internal" href="#efi-boot-partition">EFI boot partition</a></li>
<li class="toctree-l3"><a class="reference internal" href="#qemu-image-debian-sdk">QEMU image &amp; Debian SDK</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#testing-the-qemu-image">Testing the QEMU image</a></li>
<li class="toctree-l2"><a class="reference internal" href="#instrumented-build-for-testing">Instrumented build for testing</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="source-tree.html">Source tree organization</a></li>
</ul>
<p class="caption"><span class="caption-text">Contributing</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="contribute.html">How to contribute</a></li>
<li class="toctree-l1"><a class="reference internal" href="derive.html">How to derive this project</a></li>
</ul>
<p class="caption"><span class="caption-text">API &amp; Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="cosmk.html"><code class="docutils literal notranslate"><span class="pre">cosmk</span></code> Python API reference</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">CLIP OS</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
      <li>Building</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/toolkit/build.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="building">
<span id="build"></span><h1>Building<a class="headerlink" href="#building" title="Permalink to this headline">¶</a></h1>
<div class="important admonition">
<p class="first admonition-title">Before going further, ensure to get a functional build
             environment setup</p>
<p class="last">You must complete the <a class="reference internal" href="setup.html#setup"><span class="std std-ref">toolkit environment setup</span></a> before
executing any command from this page.</p>
</div>
<div class="section" id="activate-the-toolkit-environment">
<h2>Activate the toolkit environment<a class="headerlink" href="#activate-the-toolkit-environment" title="Permalink to this headline">¶</a></h2>
<p>Create and activate the CLIP OS toolkit environment in which you will be able
to use the cosmk Python module and its associated tools (such as the
<code class="docutils literal notranslate"><span class="pre">justfile</span></code>’s):</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> <span class="nb">source</span> toolkit/source_me.sh
<span class="gp">(toolkit) $</span>
</pre></div>
</div>
<p>You will then be able to use the <code class="docutils literal notranslate"><span class="pre">justfile</span></code>’s to run commands to build CLIP
OS:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="gp">(toolkit) $</span> sujust all
</pre></div>
</div>
<div class="admonition important">
<p class="first admonition-title">Important</p>
<p class="last">As some tasks need root privileges to function properly you must pay
attention to which <code class="docutils literal notranslate"><span class="pre">just</span></code> commands needs <code class="docutils literal notranslate"><span class="pre">root</span></code> privileges as there are
other <code class="docutils literal notranslate"><span class="pre">just</span></code> commands (such as helpers for source repository and branch
manipulation) which <strong>do not</strong> require <code class="docutils literal notranslate"><span class="pre">root</span></code> privileges.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>On most distributions, the default configuration will reset the
<code class="docutils literal notranslate"><span class="pre">PATH</span></code> environment variable set by <code class="docutils literal notranslate"><span class="pre">cosmk</span></code> to a fixed default value
when calling <code class="docutils literal notranslate"><span class="pre">sudo</span></code>.</p>
<p class="last">To workaround this issue without modifying your <code class="docutils literal notranslate"><span class="pre">sudoers</span></code> configuration,
the <code class="docutils literal notranslate"><span class="pre">cosmk</span></code> environment sets an alias for the sudo command to keep your
current <code class="docutils literal notranslate"><span class="pre">PATH</span></code>.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>On some distributions (e.g., Debian), the default user <code class="docutils literal notranslate"><span class="pre">$PATH</span></code> variable
does not include the <code class="docutils literal notranslate"><span class="pre">/sbin</span></code> and <code class="docutils literal notranslate"><span class="pre">/usr/sbin</span></code> folders. Please add those
to your user <code class="docutils literal notranslate"><span class="pre">$PATH</span></code>. For example:</p>
<div class="last highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> <span class="nb">export</span> <span class="nv">PATH</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$PATH</span><span class="s2">:/sbin:/usr/sbin&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="build-steps">
<h2>Build steps<a class="headerlink" href="#build-steps" title="Permalink to this headline">¶</a></h2>
<p>Building the CLIP OS project requires multiple successive steps that are
described in <a class="reference external" href="https://github.com/casey/just">Justfiles</a>. All commands are run
from the project root directory.</p>
<p>To list the available <cite>just</cite> recipes:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="gp">(toolkit) $</span> just --list
</pre></div>
</div>
<p>To run all steps required to build CLIP OS:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="gp">(toolkit) $</span> sujust all
</pre></div>
</div>
<div class="section" id="building-the-documentation">
<h3>Building the documentation<a class="headerlink" href="#building-the-documentation" title="Permalink to this headline">¶</a></h3>
<p>The project documentation is built with Sphinx. The documentation sources are
split among three directories:</p>
<blockquote>
<div><ul class="simple">
<li>the documentation root and Sphinx configuration in <code class="docutils literal notranslate"><span class="pre">toolkit/docroot</span></code>;</li>
<li>the source of the toolkit section of the documentation in
<code class="docutils literal notranslate"><span class="pre">toolkit/doc</span></code>;</li>
<li>and the source of the CLIP OS product documentation in
<code class="docutils literal notranslate"><span class="pre">products/clipos/doc</span></code>.</li>
</ul>
</div></blockquote>
<p>To build the documentation and to open it in your browser, run:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="gp">(toolkit) $</span> just doc
<span class="gp">(toolkit) $</span> just open-doc
</pre></div>
</div>
</div>
<div class="section" id="caching-and-binary-packages">
<h3>Caching and binary packages<a class="headerlink" href="#caching-and-binary-packages" title="Permalink to this headline">¶</a></h3>
<p>To speed up the build process during development, we keep the output of each
build action in the <code class="docutils literal notranslate"><span class="pre">cache</span></code> and <code class="docutils literal notranslate"><span class="pre">out</span></code> folders. The <code class="docutils literal notranslate"><span class="pre">cache</span></code> directory
keeps binary packages and SDK images. The <code class="docutils literal notranslate"><span class="pre">cache</span></code> directory keeps the
intermediate rootfs, logs and temporary files that are safe to remove before a
rebuild.</p>
<p>By default, the build commands will clear their <code class="docutils literal notranslate"><span class="pre">out</span></code> folder and reuse cached
output (mainly packages) to speedup iterative development builds. To restart
everything from scratch:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="gp">(toolkit) $</span> sujust clean
<span class="gp">(toolkit) $</span> sujust clean-cache
<span class="gp">(toolkit) $</span> sujust all
</pre></div>
</div>
<div class="note admonition">
<p class="first admonition-title">Pre-built binary packages by a continuous integration
             infrastructure</p>
<p class="last">As of 20th September 2018, we are still working on the deployment of a
continuous integration infrastructure which will provide pre-built binary
packages to speed up day-to-day work on the developer’s workstations. Once
this CI infrastructure will be deployed, some commands will be made
available to fetch those CI-built binary packages directly into the
appropriate <code class="docutils literal notranslate"><span class="pre">cache/</span></code> subdirectories.</p>
</div>
</div>
<div class="section" id="sdk">
<h3>SDK<a class="headerlink" href="#sdk" title="Permalink to this headline">¶</a></h3>
<p>To build the software components of CLIP OS, we use a SDK based on Gentoo
Hardened. The SDK container is created by importing the upstream <a class="reference external" href="https://wiki.gentoo.org/wiki/Stage_tarball#Stage_3">stage 3 root
filesystem</a> and updating
it with a current copy of the upstream Gentoo Portage tree to include various
utilities. If unavailable, the SDK is automatically build, and may be manually
rebuild from scratch using:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="gp">(toolkit) $</span> sujust products/clipos/sdk/bootstrap-from-sratch
</pre></div>
</div>
</div>
<div class="section" id="core">
<h3>Core<a class="headerlink" href="#core" title="Permalink to this headline">¶</a></h3>
<p>The main rootfs in CLIP OS is called Core, and can be built using:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="gp">(toolkit) $</span> sujust products/clipos/core
</pre></div>
</div>
</div>
<div class="section" id="efi-boot-partition">
<h3>EFI boot partition<a class="headerlink" href="#efi-boot-partition" title="Permalink to this headline">¶</a></h3>
<p>EFI boot is the only supported boot method. The content of the EFI boot
partition (bootloader, kernel image, etc.) is built using:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="gp">(toolkit) $</span> sujust products/clipos/efiboot
</pre></div>
</div>
</div>
<div class="section" id="qemu-image-debian-sdk">
<h3>QEMU image &amp; Debian SDK<a class="headerlink" href="#qemu-image-debian-sdk" title="Permalink to this headline">¶</a></h3>
<p>In order to test the resulting OS, we use <code class="docutils literal notranslate"><span class="pre">libguestfs</span></code> tools to assemble a
QEMU qcow2 disk image to boot inside a EFI enabled virtual machine using
<code class="docutils literal notranslate"><span class="pre">libvirt</span></code>.</p>
<p>Similarly to the Gentoo Hardened based SDK, the Debian SDK is automatically
built, and may be manually rebuilt from scratch using:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="gp">(toolkit) $</span> sujust products/clipos/sdk_debian/bootstrap-from-scratch
</pre></div>
</div>
<p>The qcow2 QEMU image may then be assembled using:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="gp">(toolkit) $</span> sujust products/clipos/qemu/bundle
</pre></div>
</div>
</div>
</div>
<div class="section" id="testing-the-qemu-image">
<h2>Testing the QEMU image<a class="headerlink" href="#testing-the-qemu-image" title="Permalink to this headline">¶</a></h2>
<p>To setup a EFI &amp; QEMU/KVM enabled virtual machine with <code class="docutils literal notranslate"><span class="pre">libvirt</span></code>, use:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="gp">(toolkit) $</span> sujust products/clipos/qemu/run
</pre></div>
</div>
</div>
<div class="section" id="instrumented-build-for-testing">
<h2>Instrumented build for testing<a class="headerlink" href="#instrumented-build-for-testing" title="Permalink to this headline">¶</a></h2>
<p>The default build configuration will create production images with root access
disabled. In order to test the QEMU images, you have to select the
instrumentation level you want by copying the
<code class="docutils literal notranslate"><span class="pre">toolkit/instrumentation.toml.example</span></code> example in the source tree root
folder:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="gp">(toolkit) $</span> cp toolkit/instrumentation.toml.example instrumentation.toml
</pre></div>
</div>
<p>The default instrumented configuration will enable you to log as root in
without password. You will have to rebuild the project and the QEMU image to
apply the change:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="gp">(toolkit) $</span> sujust all
<span class="gp">(toolkit) $</span> sujust qemu
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="source-tree.html" class="btn btn-neutral float-right" title="Source tree organization" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="setup.html" class="btn btn-neutral" title="Environment setup" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, ANSSI. CLIP OS is a trademark of the French Republic. For more details, see the &#34;How to derive this project&#34; section. The contents of this documentation is available under the Open License version 2.0 as published by Etalab (French task force for Open Data).

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'5.0.0_alpha1',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>

  

  <script type="text/javascript" src="../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>