

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Build steps &mdash; CLIP OS 5.0.0_beta3 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/graphviz.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/colors.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Source tree organization" href="source-tree.html" />
    <link rel="prev" title="Testing" href="test.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> CLIP OS
          

          
            
            <img src="../_static/clipos_logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                5.0 (Beta)
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">CLIP OS</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../clipos/architecture.html">Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../clipos/security.html">Security objectives</a></li>
<li class="toctree-l1"><a class="reference internal" href="../clipos/kernel.html">Kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../clipos/boot_integrity.html">Boot chain and integrity guarantees</a></li>
<li class="toctree-l1"><a class="reference internal" href="../clipos/update.html">System updates</a></li>
<li class="toctree-l1"><a class="reference internal" href="../clipos/roadmap.html">Roadmap</a></li>
<li class="toctree-l1"><a class="reference internal" href="../clipos/development.html">Development and debug</a></li>
</ul>
<p class="caption"><span class="caption-text">Development environment</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="quick-try.html">Quick try guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="setup.html">Environment setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="build.html">Building</a></li>
<li class="toctree-l1"><a class="reference internal" href="test.html">Testing</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Build steps</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#building-the-documentation">Building the documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#sdk">SDK</a></li>
<li class="toctree-l2"><a class="reference internal" href="#core">Core</a></li>
<li class="toctree-l2"><a class="reference internal" href="#efi-boot-partition">EFI boot partition</a></li>
<li class="toctree-l2"><a class="reference internal" href="#initial-state-for-qemu-test-image">Initial state for QEMU test image</a></li>
<li class="toctree-l2"><a class="reference internal" href="#qemu-image">QEMU image</a></li>
<li class="toctree-l2"><a class="reference internal" href="#testbed-environment-setup">Testbed environment setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="#testing-the-qemu-image">Testing the QEMU image</a></li>
<li class="toctree-l2"><a class="reference internal" href="#caching-and-binary-packages">Caching and binary packages</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="source-tree.html">Source tree organization</a></li>
</ul>
<p class="caption"><span class="caption-text">Contributing</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="contribute.html">How to contribute</a></li>
<li class="toctree-l1"><a class="reference internal" href="derive.html">How to derive this project</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">CLIP OS</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
      <li>Build steps</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/toolkit/build-steps.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="build-steps">
<span id="id1"></span><h1>Build steps<a class="headerlink" href="#build-steps" title="Permalink to this headline">¶</a></h1>
<div class="admonition important">
<p class="first admonition-title">Important</p>
<p class="last">This page details the purpose of each step in the project build process.
Running steps manually is generally not needed for development as you may
use directly the instructions from the <a class="reference internal" href="build.html#build"><span class="std std-ref">Building page</span></a>.</p>
</div>
<div class="section" id="building-the-documentation">
<h2>Building the documentation<a class="headerlink" href="#building-the-documentation" title="Permalink to this headline">¶</a></h2>
<p>The project documentation is built with Sphinx. The documentation sources are
available in the <code class="docutils literal notranslate"><span class="pre">docs-src</span></code> directory.</p>
<p>To build the documentation and to open it in your browser, run:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> cosmk doc build
<span class="gp">$</span> cosmk doc open
</pre></div>
</div>
</div>
<div class="section" id="sdk">
<h2>SDK<a class="headerlink" href="#sdk" title="Permalink to this headline">¶</a></h2>
<p>To build the software components of CLIP OS, we use a SDK based on Gentoo
Hardened. The SDK container is created by importing the upstream <a class="reference external" href="https://wiki.gentoo.org/wiki/Stage_tarball#Stage_3">stage 3 root
filesystem</a> and updating
it with a current copy of the upstream Gentoo Portage tree to include various
utilities. If unavailable, the SDK is automatically imported from the
configured CI or build locally, and may be manually rebuild from scratch using:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="gp">#</span> Remove the current SDK container images
<span class="gp">$</span> podman rmi &lt;registry&gt;/clipos/sdk:&lt;version&gt;       <span class="c1"># podman</span>
<span class="gp">$</span> sudo docker rmi &lt;registry&gt;/clipos/sdk:&lt;version&gt;  <span class="c1"># Docker</span>

<span class="gp">#</span> Set empty URLs <span class="k">for</span> the <span class="s1">&#39;registry&#39;</span> in the <span class="s1">&#39;ci&#39;</span> section of the <span class="s1">&#39;config.toml&#39;</span>
<span class="gp">$</span> <span class="nv">$EDITOR</span> config.toml

<span class="gp">#</span> Bootstrap the SDK
<span class="gp">$</span> cosmk bootstrap sdk
</pre></div>
</div>
</div>
<div class="section" id="core">
<h2>Core<a class="headerlink" href="#core" title="Permalink to this headline">¶</a></h2>
<p>The main rootfs in CLIP OS is called Core, and can be built using:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> cosmk build core
<span class="gp">$</span> cosmk image core
<span class="gp">$</span> cosmk configure core
<span class="gp">$</span> cosmk bundle core
</pre></div>
</div>
</div>
<div class="section" id="efi-boot-partition">
<h2>EFI boot partition<a class="headerlink" href="#efi-boot-partition" title="Permalink to this headline">¶</a></h2>
<p>EFI boot is the only supported boot method. The content of the EFI boot
partition (bootloader, kernel image, etc.) is built using:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> cosmk build efiboot
<span class="gp">$</span> cosmk image efiboot
<span class="gp">$</span> cosmk configure efiboot
<span class="gp">$</span> cosmk bundle efiboot
</pre></div>
</div>
</div>
<div class="section" id="initial-state-for-qemu-test-image">
<h2>Initial state for QEMU test image<a class="headerlink" href="#initial-state-for-qemu-test-image" title="Permalink to this headline">¶</a></h2>
<p>To test the resulting OS in a QEMU virtual machine, we generate a tarball with
the configuration to be installed in the system state partition:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> cosmk bundle qemu
</pre></div>
</div>
</div>
<div class="section" id="qemu-image">
<h2>QEMU image<a class="headerlink" href="#qemu-image" title="Permalink to this headline">¶</a></h2>
<p>In order to test the resulting OS, we use <code class="docutils literal notranslate"><span class="pre">libguestfs</span></code> tools to assemble a
QEMU qcow2 disk image to boot inside a EFI enabled virtual machine using
<code class="docutils literal notranslate"><span class="pre">libvirt</span></code>. The qcow2 QEMU image may be assembled using:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> cosmk <span class="nb">test</span> qemu
</pre></div>
</div>
</div>
<div class="section" id="testbed-environment-setup">
<h2>Testbed environment setup<a class="headerlink" href="#testbed-environment-setup" title="Permalink to this headline">¶</a></h2>
<p>To setup the virtual testbed environment with <code class="docutils literal notranslate"><span class="pre">Vagrant</span></code> and <code class="docutils literal notranslate"><span class="pre">libvirt</span></code>, use:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> cosmk <span class="nb">test</span> setup
</pre></div>
</div>
</div>
<div class="section" id="testing-the-qemu-image">
<h2>Testing the QEMU image<a class="headerlink" href="#testing-the-qemu-image" title="Permalink to this headline">¶</a></h2>
<p>To setup a EFI &amp; QEMU/KVM enabled virtual machine with <code class="docutils literal notranslate"><span class="pre">libvirt</span></code>, use:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> cosmk <span class="nb">test</span> run
</pre></div>
</div>
</div>
<div class="section" id="caching-and-binary-packages">
<h2>Caching and binary packages<a class="headerlink" href="#caching-and-binary-packages" title="Permalink to this headline">¶</a></h2>
<p>To speed up the build process during development, we keep the output of each
build action in the <code class="docutils literal notranslate"><span class="pre">cache</span></code> and <code class="docutils literal notranslate"><span class="pre">out</span></code> folders. The <code class="docutils literal notranslate"><span class="pre">cache</span></code> directory
keeps binary packages and logs. The <code class="docutils literal notranslate"><span class="pre">out</span></code> directory keeps the intermediate
rootfs and temporary files that are safe to remove before a rebuild.</p>
<p>By default, the <code class="docutils literal notranslate"><span class="pre">cosmk</span></code> tool will clear the <code class="docutils literal notranslate"><span class="pre">out</span></code> folder and reuse cached
output (mainly packages) to speedup iterative development builds. To restart
everything from scratch:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> rm -rf out cache
<span class="gp">#</span> If using Docker or rootfull podman
<span class="gp">$</span> sudo rm -rf out cache
</pre></div>
</div>
<div class="important admonition">
<p class="first admonition-title">Pre-built binary packages by a continuous integration
             infrastructure (GitLab CI)</p>
<p class="last">We use GitLab CI to automatically build CLIP OS. The GitLab CI configuration
and build scripts are tracked in the <a class="reference external" href="https://github.com/clipos/ci">clipos/ci</a> repository and the resulting artifacts are
made available at <a class="reference external" href="https://files.clip-os.org/">files.clip-os.org</a>.</p>
</div>
<p>To download CI-built binary packages from the last successful CI job, use:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> cosmk cache
</pre></div>
</div>
<p>SDKs are automatically downloaded from the CI if configured in <code class="docutils literal notranslate"><span class="pre">config.toml</span></code>.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="source-tree.html" class="btn btn-neutral float-right" title="Source tree organization" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="test.html" class="btn btn-neutral float-left" title="Testing" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, ANSSI. CLIP OS is a trademark of the French Republic. For more details, see the &#34;How to derive this project&#34; section. The contents of this documentation is available under the Open License version 2.0 as published by Etalab (French task force for Open Data)

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>